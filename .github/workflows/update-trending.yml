name: Update GitHub Trending

# å·¥ä½œæµè§¦å‘æ¡ä»¶
on:
  # å®šæ—¶è§¦å‘ï¼šæ¯å¤©æ—©ä¸Š8ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰æ‰§è¡Œ
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤© 00:00 UTC (åŒ—äº¬æ—¶é—´ 08:00)
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      repo_limit:
        description: 'é¡¹ç›®æ•°é‡é™åˆ¶'
        required: false
        default: '10'
        type: string

# ç¯å¢ƒå˜é‡
env:
  PYTHON_VERSION: '3.11'
  TIMEZONE: 'Asia/Shanghai'

jobs:
  update-trending:
    runs-on: ubuntu-latest
    
    # è®¾ç½®æƒé™
    permissions:
      contents: write
      actions: read
      
    # è®¾ç½®è¶…æ—¶æ—¶é—´ï¼ˆ30åˆ†é’Ÿï¼‰
    timeout-minutes: 30
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          # éœ€è¦å®Œæ•´å†å²è®°å½•ä»¥ä¾¿æäº¤æ›´æ”¹
          fetch-depth: 0
          # ä½¿ç”¨GitHub Tokenè¿›è¡Œè®¤è¯
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. è®¾ç½®Pythonç¯å¢ƒ
      - name: ğŸ”§ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # 3. å®‰è£…ä¾èµ–
      - name: ğŸ“¦ Install dependencies
        run: |
          echo "å®‰è£…Pythonä¾èµ–..."
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "è­¦å‘Š: æœªæ‰¾åˆ°requirements.txtæ–‡ä»¶"
          fi

      # 4. è®¾ç½®æ—¶åŒº
      - name: ğŸŒ Set timezone
        run: |
          sudo timedatectl set-timezone ${{ env.TIMEZONE }}
          echo "å½“å‰æ—¶é—´: $(date)"

      # 5. æ£€æŸ¥é…ç½®
      - name: âš™ï¸ Check configuration
        run: |
          echo "ğŸ” æ£€æŸ¥ç¯å¢ƒå˜é‡..."
          echo "GITHUB_TOKEN: ${GITHUB_TOKEN:0:10}..."
          echo ""
          echo "æ£€æŸ¥Pythonç¯å¢ƒ..."
          python --version
          pip --version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 6. æ‰§è¡Œè¶‹åŠ¿æ›´æ–°
      - name: ğŸš€ Update trending repositories
        run: |
          # æ‰§è¡ŒPythonè„šæœ¬æ›´æ–°è¶‹åŠ¿æ•°æ®
          echo "æ‰§è¡Œè¶‹åŠ¿æ›´æ–°è„šæœ¬..."
          python daily_update.py
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SILICONFLOW_API_KEY: ${{ secrets.SILICONFLOW_API_KEY }}
          AI_BASE_URL: ${{ secrets.AI_BASE_URL || 'https://api.siliconflow.cn/v1' }}
          AI_MODEL: ${{ secrets.AI_MODEL || 'Pro/moonshotai/Kimi-K2-Instruct' }}

      # 7. æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
      - name: ğŸ“‹ Check for changes
        id: changes
        run: |
          git add .
          if git diff --staged --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "ğŸ“ æ²¡æœ‰æ£€æµ‹åˆ°å˜æ›´"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ æ£€æµ‹åˆ°ä»¥ä¸‹å˜æ›´:"
            git diff --staged --name-only
          fi

      # 8. æäº¤å˜æ›´
      - name: ğŸ’¾ Commit changes
        if: steps.changes.outputs.changes == 'true'
        run: |
          # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # è·å–å½“å‰å‘¨ä¿¡æ¯
          WEEK_INFO=$(date +"%Yå¹´ç¬¬%Vå‘¨")
          
          # ç”Ÿæˆæäº¤ä¿¡æ¯
          COMMIT_MSG="ğŸ“Š æ›´æ–°GitHubè¶‹åŠ¿æ’è¡Œæ¦œ - $WEEK_INFO

          ğŸ¤– ç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ
          ğŸ“… æ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')
          ğŸ“Š æ•°æ®æ¥æº: GitHub API + AIæ™ºèƒ½æ€»ç»“
          
          Co-authored-by: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
          
          # æäº¤å˜æ›´
          git commit -m "$COMMIT_MSG"
          
          echo "âœ… å˜æ›´å·²æäº¤"

      # 9. æ¨é€åˆ°è¿œç¨‹ä»“åº“
      - name: ğŸš€ Push changes
        if: steps.changes.outputs.changes == 'true'
        run: |
          git push origin main
          echo "âœ… å˜æ›´å·²æ¨é€åˆ°è¿œç¨‹ä»“åº“"

      # 10. ç”ŸæˆæŠ¥å‘Šæ‘˜è¦
      - name: ğŸ“Š Generate summary
        if: steps.changes.outputs.changes == 'true'
        run: |
          echo "## ğŸ“ˆ GitHubè¶‹åŠ¿æ’è¡Œæ¦œæ›´æ–°å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“… æ›´æ–°ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **æ›´æ–°æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å·¥ä½œæµ**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ˜¾ç¤ºå‚æ•°ï¼ˆå¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ï¼‰
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "### âš™ï¸ æ‰§è¡Œå‚æ•°" >> $GITHUB_STEP_SUMMARY
            echo "- **é¡¹ç›®æ•°é‡**: ${{ github.event.inputs.repo_limit || '10' }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "### ğŸ”— æŸ¥çœ‹ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "- [ğŸ“– æŸ¥çœ‹README](../README.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [ğŸ“‚ å†å²æ•°æ®](../archives/)" >> $GITHUB_STEP_SUMMARY

  # é”™è¯¯å¤„ç†å’Œé€šçŸ¥ä½œä¸š
  notify-on-failure:
    runs-on: ubuntu-latest
    needs: update-trending
    if: failure()
    
    steps:
      - name: ğŸ“§ Send failure notification
        run: |
          echo "âŒ GitHubè¶‹åŠ¿æ’è¡Œæ¦œæ›´æ–°å¤±è´¥"
          echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "å·¥ä½œæµ: ${{ github.workflow }}"
          echo "è¿è¡ŒID: ${{ github.run_id }}"
          echo ""
          echo "è¯·æŸ¥çœ‹å·¥ä½œæµæ—¥å¿—äº†è§£è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼š"
          echo "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å…¶ä»–é€šçŸ¥æ–¹å¼ï¼Œå¦‚é‚®ä»¶ã€Slackç­‰
      # - name: ğŸ“§ Send email notification
      #   uses: dawidd6/action-send-mail@v3
      #   with:
      #     server_address: smtp.gmail.com
      #     server_port: 587
      #     username: ${{ secrets.EMAIL_USERNAME }}
      #     password: ${{ secrets.EMAIL_PASSWORD }}
      #     subject: GitHubè¶‹åŠ¿æ’è¡Œæ¦œæ›´æ–°å¤±è´¥
      #     body: å·¥ä½œæµæ‰§è¡Œå¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ã€‚
